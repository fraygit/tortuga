@{
    ViewBag.Title = "DocumentEditor";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}
@model tortuga.MongoData.Entities.Model.DocumentSchema

<div class="row">
    <div class="col-md-12">
        <section class="panel">
            <header class="panel-heading sm">
                <h2>Document Builder </h2>
            </header>
            <div class="panel-body">
                <form role="form">
                    <div class="form-group">
                        <label>Document Name</label>
                        <input type="text" class="form-control" placeholder="Document Name" id="txtDocumentName">
                    </div>

                    <div id="navcontainer">
                        <ul class="root">
                            <li>
                                <div class="document-item">
                                    @Model.Name 
                                </div>
                                <div class="listPanel"></div>
                            </li>
                        </ul>
                    </div>

                    <button type="button" class="btn btn-primary">Add a Field</button>

                </form>
            </div>

            <footer class="panel-footer">
                <button type="button" class="btn btn-primary" id="btn-save">Save Document</button>
                <button type="reset" class="btn">Cancel</button>
            </footer>
        </section>
    </div>
</div>

<div id="md-normal" class="modal fade" tabindex="-1" aria-hidden="true" style="display: none; margin-top: -63px;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
        <h4 class="modal-title">Field Details</h4>
    </div>
    <!-- //modal-header-->
    <div class="modal-body">
        <form>
            <div id="FieldDetails" data-field-guid=""></div>
            <div class="form-group">
                <label for="txtFieldName">Parent</label>
                <input lass="form-control" id="txtRoot" value="Root" disabled>
            </div>
            <div class="form-group">
                <label for="txtFieldName">Field Name</label>
                <input class="form-control" id="txtFieldName" placeholder="Field Name">
            </div>
            <div class="form-group">
                <label for="exampleInputPassword1">Data Type</label>
                <select class="form-control" id="dropDataType">
                    <option>String</option>
                    <option>Number</option>
                    <option>Date</option>
                    <option>Document</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary" id="btnSaveField">Save</button>
        </form>
    </div>
    <!-- //modal-body-->
</div>


@section Scripts {
    <script language="javascript">
    var documentSchema = @Html.Raw(Json.Encode(Model));

        $(document).ready(function(){

            var defUpdateDocumentSchema;

            console.log('load initial');
            LoadFieldList(documentSchema);

            function LoadFieldList(documentSchemaToLoad){
                $(".listPanel").html('loading..');
                $.ajax({
                    url: '@Url.Action("ListFields", "Document")',
                    data: JSON.stringify(documentSchemaToLoad),
                    contentType: 'application/json',
                    type: 'POST',
                    dataType: 'HTML'
                }).success(function(result){
                    documentSchema = documentSchemaToLoad;
                    $(".listPanel").html(result);
                });
            }

            $("body").on("click", ".document-item a", function (e) {
                e.preventDefault();
                var fieldGuid = $(this).data("document-guid");

                SearchField("Root", fieldGuid, documentSchema.Fields, function(field, rootName){
                    $("#txtFieldName").val(field.Name);
                    $("#txtRoot").val(rootName);

                    var selectedDataType = GetCurrentDataType(field);
                    $("#dropDataType").val(selectedDataType);
                    $("#FieldDetails").data("field-guid", field.FieldGuid);
                });           

                $("#md-normal").modal('show');
                return false;
            });

            $("body").on("click", "#btnSaveField", function(){
                var fieldGuid = $("#FieldDetails").data("field-guid");
                UpdateDocumentSchema (documentSchema.Fields, fieldGuid, function(newFields){
                    $("#md-normal.in").modal('hide');
                    var newDocumentSchema = {Name : documentSchema.Name, Id: documentSchema.Id, Fields: newFields};
                    console.log('load update');
                    LoadFieldList(newDocumentSchema);
                });
                return false;
            });

            function GetCurrentDataType(field){
                var selectedDataType;
                switch(field.DataType){
                    case 0:
                        selectedDataType = "String";
                        break;
                    case 1:
                        selectedDataType = "Number";
                        break;
                    case 3:
                        selectedDataType = "Document";
                        break;
                }
                return selectedDataType;
            }

            function UpdateDocumentSchema (fields, fieldGuid, callback){
                var newFields = [];
                $.each(fields, function(index, item){
                    if (item.FieldGuid == fieldGuid)
                    {
                        item.Name = $("#txtFieldName").val();
                    }
                    if (item.Fields != null){
                        UpdateDocumentSchema(item.Fields, fieldGuid, function(newChildFields){
                            item.Fields = newChildFields;
                        });
                    }
                    newFields.push(item);
                });
                callback(newFields);
            }

            function SearchField(parentname, fieldGuid, fields, cb){
                var root = parentname;
                $.each(fields, function(index, item){
                    if (item.FieldGuid == fieldGuid)
                    {
                        cb(item, root);
                        return false;
                    }
                    if (item.Fields != null){
                        SearchField(item.Name, fieldGuid, item.Fields, function(d, pr){
                            cb(d, pr);
                            return false;
                        });
                    }

                });                
            }

        });

    </script>
    
}